#!/usr/bin/env sh

# –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç
COMMIT_MSG=$(git log -1 --pretty=%B)
COMMIT_HASH=$(git rev-parse --short HEAD)
REPO_URL=$(git remote get-url origin)

# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º URL –¥–ª—è SSH –∏ HTTPS
if echo "$REPO_URL" | grep -q "git@github.com"; then
    # SSH —Ñ–æ—Ä–º–∞—Ç: git@github.com:username/repo.git
    REPO_URL=$(echo "$REPO_URL" | sed 's/git@github.com:/https:\/\/github.com\//' | sed 's/\.git$//')
else
    # HTTPS —Ñ–æ—Ä–º–∞—Ç: https://github.com/username/repo.git
    REPO_URL=$(echo "$REPO_URL" | sed 's/\.git$//')
fi

if echo "$COMMIT_MSG" | grep -q "^fix: #[0-9]"; then
    ISSUE_NUMBER=$(echo "$COMMIT_MSG" | grep -o '#[0-9]*' | sed 's/#//')
    echo "üîß –î–æ–±–∞–≤–ª—è—é —Å—Å—ã–ª–∫—É –Ω–∞ –∫–æ–º–º–∏—Ç –≤ issue #$ISSUE_NUMBER..."
    
    COMMIT_LINK="$REPO_URL/commit/$COMMIT_HASH"
    echo "–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–æ–º–º–∏—Ç: $COMMIT_LINK"
    
    gh issue close "$ISSUE_NUMBER" --comment "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –∫–æ–º–º–∏—Ç–µ: [$COMMIT_HASH]($COMMIT_LINK) - $COMMIT_MSG"
fi
